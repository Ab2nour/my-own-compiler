# On teste automatiquement
# le code ANTLR4.

name: CI
on:  push
jobs:
  test-code:
    name: Teste Calculette.g4
    runs-on: ubuntu-latest
    steps:    
    - uses: actions/checkout@v2
    - name: Script d'initialisation
      run: | # cf tools/installations.txt
            
            cd tools
            
            export CLASSPATH=.:$(pwd)/antlr-4.9.2-complete.jar:$(pwd)/mvap/MVaP.jar:$CLASSPATH

            alias antlr4='java -Xmx500M -cp "$(pwd)/antlr-4.9.2-complete.jar:$CLASSPATH" org.antlr.v4.Tool'
            alias grun='java -Xmx500M -cp "$(pwd)/antlr-4.9.2-complete.jar:$CLASSPATH" org.antlr.v4.gui.TestRig'
            cd mvap
            jar cfm MVaP.jar META-INF/MANIFEST.MF *.class
            cd ..

            chmod +x $(pwd)/{mvap,mvap_sans_grammaire}.sh
            alias mvap='$(pwd)/mvap.sh'
            alias mvap_sans_grammaire='$(pwd)/mvap_sans_grammaire.sh'
    
    - name: Test d'expressions simples
      run: |
            cd .
            
            # ---------------- Fonctions ----------------
            function antlr4 () {
                java -Xmx500M -cp "$(pwd)/antlr-4.9.2-complete.jar:$CLASSPATH" org.antlr.v4.Tool $@
            }

            function grun () {
                java -Xmx500M -cp "$(pwd)/antlr-4.9.2-complete.jar:$CLASSPATH" org.antlr.v4.gui.TestRig $@
            }

            function compileMVAP () {
                java -cp $CLASSPATH MVaPAssembler $@
            }

            function execMVAP () {
                java -jar mvap/MVaP.jar $@
            }
            
            
            function mvap () {
                cd tools
                
                antlr4 ../Calculette.g4                
                javac *.java
                echo $@ | grun Calculette 'start' > fichier.mvap
                
                compileMVAP fichier.mvap
                
                execMVAP fichier.mvap.cbap
                
                cd .
            }
            
            function mvap_sans_grammaire () { # todo
                cd tools
                ./mvap_sans_grammaire.sh
                cd .
            }
            
            
            # ---------------- Code ----------------
            resultat=$(mvap '3+5')
            echo $resultat
            
      shell: bash
